---
title: "Health Insurance Cost Modeling"
output:
  github_document: default
  pdf_document: default
  html_document: default
---
<center>
  <subtitle>Kyle Offenloch</subtitle>
  <br>
  <subtitle>August 30, 2025</subtitle>
</center>

## Data used in this Project:

Health Insurance dataset from kaggle.com

<https://www.kaggle.com/datasets/willianoliveiragibin/healthcare-insurance>

Includes information on attributes of 1338 insured individuals, including their age, sex, BMI, number of children, smoking habits, and region. It also includes their medical costs incurred.

## Goal of this project:

-   Analyze data to infer effects of other variables on medical costs.
-   Create generalized linear models using different assumptions to predict costs.
-   Test and compare models.

# General Analysis

First, we break down the data to look at the entire picture.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
library("ggplot2")
library("tidyr")
library("dplyr")
library("gridExtra")


#importing data
data <- read.csv("insurance.csv")


#making charts to view raw training data
agechart<-ggplot(data, aes(x = age)) +
  geom_histogram(binwidth = 1,fill = "steelblue", color = "white") +
  ggtitle("age Distribution") +
  theme_minimal()
sexchart<-ggplot(data, aes(x = "", fill=sex)) +
  geom_bar(width=1, color="blue") +
  coord_polar(theta = "y") +
  ggtitle("sex Distribution") +
  theme_void()
bmichart<-ggplot(data, aes(x=bmi)) +
  geom_histogram(binwidth=1, fill="steelblue", color="white") +
  ggtitle("bmi Distribution") +
  theme_minimal()
childrenchart<-ggplot(data, aes(x=children)) +
  geom_histogram(binwidth=1, fill="steelblue", color="white") +
  ggtitle("child Distribution") +
  theme_minimal()
smokerchart<-ggplot(data, aes(x = "", fill=smoker)) +
  geom_bar(width=1, color="blue") +
  coord_polar(theta = "y") +
  ggtitle("smoker Distribution") +
  theme_void()
regionchart<-ggplot(data, aes(x = "", fill=region)) +
  geom_bar(width=1, color="blue") +
  coord_polar(theta = "y") +
  ggtitle("region Distribution") +
  theme_void()
chargeschart<-ggplot(data, aes(x=charges)) +
  geom_histogram(bins = 50, fill="steelblue", color="white") +
  ggtitle("expenses Distribution") +
  theme_minimal()


#overview of all raw data
grid.arrange(agechart, sexchart, bmichart, childrenchart, smokerchart, regionchart, chargeschart)
```

These are the histograms, bar charts, and pie charts of each of the 7 attributes in this data set, helping us see the general frequency and distributions of the variables.

Now we will plot medical charges against different attributes to deduce the relationship, also including smoking status in each chart.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
ggplot(data, aes(x=factor(smoker), y=charges))  + labs(y="Charges", x="Smoking Status", title="Charges by Smoking Status") + geom_boxplot(fill="steelblue")
```

Big difference in Charges by smoking status.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
 ggplot(data, aes(x=age, y=charges, color = factor(smoker))) + labs(y="Charges", x="Age", title="Charges vs Age by Smoker", color="Smoker") + geom_point() + geom_smooth()
```

Positive trend in charges with age, sizable difference between smoker and non-smoker charges, with smoker charges having very high variance.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
ggplot(data, aes(x=bmi, y=charges, color = factor(smoker))) + labs(y="Charges", x="BMI", title="Charges vs BMI by Smoker", color="Smoker") + geom_point() + geom_smooth()
```

Very little trend in charges with BMI for nonsmokers, large jump in charges for smokers with BMI over 30.

```{r, echo=FALSE, message=FALSE, warning = FALSE}
ggplot(data, aes(x=factor(children), y=charges)) + labs(y="Charges", x="Children", title="Charges vs Number of Children by Smoker") + geom_boxplot(fill="steelblue") + facet_grid(~smoker)
ggplot(data, aes(x=factor(region), y=charges)) + labs(y="Charges", x="Region", title="Charges vs Region by Smoker") + geom_boxplot(fill="steelblue") + facet_grid(~smoker)
ggplot(data, aes(x=factor(sex), y=charges)) + labs(y="Charges", x="Sex", title="Charges vs Sex by Smoker") + geom_boxplot(fill="steelblue") + facet_grid(~smoker)
```

Very little trend in charges with no. of children, region or sex. 

## Conclusion of attributes effects on charges
  * Smoking has the largest effect on charges, showing up in every other chart when plotted with other attributes
  * Age has a slight effect on charges the higher it is
  * BMI has a quite large effect on charges in smokers, but not much for nonsmokers

# Building Models

We will build six different models, training them on 2/3 of the data, then testing them on the other 1/3.

These will all be generalized linear models:

Model 1: Normal linear regression model with all six variables. This model will include unrealistic negative cost predictions as a side effect of assuming gaussian error terms and fully linear relationships between variables.

```{r, echo=FALSE}
set.seed(123)
split.ratio <- 2/3

train_indices<-sample(seq_len(nrow(data)), size = floor(split.ratio * nrow(data)))

train_data<-data[train_indices,]
test_data<-data[-train_indices,]
```
```{r, echo=TRUE}
model1<-lm(charges ~ age + sex + bmi + children + smoker + region, data = train_data)

predictions1 <- predict(model1,newdata=test_data)

test_data <- data.frame(test_data,Model1Prediction=predictions1)
```

Model 2: Normal linear regression model with only age, bmi, and smoker status. This model will include unrealistic negative cost predictions as a side effect of assuming gaussian error terms and fully linear relationships between variables.

```{r, echo=TRUE}
model2<-lm(charges ~ age + bmi + smoker, data = train_data)

predictions2 <- predict(model2,newdata=test_data)

test_data <- data.frame(test_data,Model2Prediction=predictions2)
```

Model 3: Gamma regression with all six variables. Using gamma regression makes more sense for health costs due to right skewness and strict positivity.

```{r, echo=TRUE}
model3 <- glm(charges ~ age + sex + bmi + children + smoker + region, data=train_data, family=Gamma(link="log"))

predictions3 <- predict(model3, newdata=test_data, type="response")

test_data <- data.frame(test_data, Model3Prediction=predictions3)
```

Model 4: Gamma regression with only age, bmi, smoker status.

```{r, echo=TRUE}
model4 <- glm(charges ~ age + bmi + smoker, data=train_data, family=Gamma(link="log"))

predictions4 <- predict(model4, newdata=test_data, type="response")

test_data <- data.frame(test_data, Model4Prediction=predictions4)
```

Model 5: Gamma regression with all 6 variables, including interactions with smoker status, allowing smoking to have different effects on costs when combined with other attributes.

```{r, echo=TRUE}
model5 <- glm(charges ~ smoker * (age + bmi + children + region + sex),
                      data = train_data,
                      family = Gamma(link = "log"))

predictions5 <- predict(model5, newdata=test_data, type="response")

test_data <- data.frame(test_data, Model5Prediction=predictions5)
```

Model 6: Gamma regression with age, BMI, and smoking status. With interactions between smoking status and other variables.

```{r, echo=TRUE}
model6 <- glm(charges ~ smoker * (age + bmi),
              data = train_data,
              family = Gamma(link = "log"))

predictions6 <- predict(model6, newdata=test_data, type="response")

test_data <- data.frame(test_data, Model6Prediction=predictions6)
```

## Testing Models

Now we can view how well each model predicts the medical costs of the people it's not trained on. The line on the graphs is the y=x line (where all predictions are equal to the charges). We wish for the model plots to be as close to it as possible.

```{r, echo=FALSE}
RMSE1<-sqrt(sum((test_data$Model1Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)
RMSE2<-sqrt(sum((test_data$Model2Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)
RMSE3<-sqrt(sum((test_data$Model3Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)
RMSE4<-sqrt(sum((test_data$Model4Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)
RMSE5<-sqrt(sum((test_data$Model5Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)
RMSE6<-sqrt(sum((test_data$Model6Prediction-test_data$charges)^2)/nrow(test_data)) |> round(2)


r_squared_1 <- (1-sum((test_data$Model1Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)
r_squared_2 <- (1-sum((test_data$Model2Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)
r_squared_3 <- (1-sum((test_data$Model3Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)
r_squared_4 <- (1-sum((test_data$Model4Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)
r_squared_5 <- (1-sum((test_data$Model5Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)
r_squared_6 <- (1-sum((test_data$Model6Prediction-test_data$charges)^2)/sum((test_data$charges-mean(test_data$charges))^2)) |> round(3)

MAE1 <- mean(abs(test_data$Model1Prediction-test_data$charges)) |> round(2)
MAE2 <- mean(abs(test_data$Model2Prediction-test_data$charges)) |> round(2)
MAE3 <- mean(abs(test_data$Model3Prediction-test_data$charges)) |> round(2)
MAE4 <- mean(abs(test_data$Model4Prediction-test_data$charges)) |> round(2)
MAE5 <- mean(abs(test_data$Model5Prediction-test_data$charges)) |> round(2)
MAE6 <- mean(abs(test_data$Model6Prediction-test_data$charges)) |> round(2)


model1Plot <- ggplot(data=test_data, aes(Model1Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 1", x = "Prediction", y = "Charges")

model2Plot <- ggplot(data=test_data, aes(Model2Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 2", x = "Prediction", y = "Charges")
  
grid.arrange(model1Plot, model2Plot)
paste("RMSE1:",RMSE1)
paste("MAE1:",MAE1)
paste("R^2_1:",r_squared_1)
paste("RMSE2:",RMSE2)
paste("MAE2:",MAE2)
paste("R^2_2:",r_squared_2)
```

It looks like the linear regression models with gaussian error did an okay job of predicting costs for nonsmokers albeit the spread is very inconsistent.
For smokers it overshot many by ~7000 and undershot many by ~7000. This could be due to the BMI having more of an effect on smokers after age 30 and these models having no interaction, only taking into account the age effect, smoker effect, and BMI effect independent of their effects on each other.


```{r, echo=FALSE}

model3Plot <- ggplot(data=test_data, aes(Model3Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 3", x = "Prediction", y = "Charges") +
  ylim(0, max(test_data$Model3Prediction, test_data$charges) + 2000) +
  xlim(0, max(test_data$Model3Prediction, test_data$charges) + 2000)
  
model4Plot <- ggplot(data=test_data, aes(Model4Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 4", x = "Prediction", y = "Charges") +
  ylim(0, max(test_data$Model4Prediction, test_data$charges) + 2000) +
  xlim(0, max(test_data$Model4Prediction, test_data$charges) + 2000)
  
grid.arrange(model3Plot, model4Plot)
paste("RMSE3:",RMSE3)
paste("MAE3:",MAE3)
paste("R^2_3:",r_squared_3)
paste("RMSE4:",RMSE4)
paste("MAE4:",MAE4)
paste("R^2_4:",r_squared_4)
```

The gamma regression models did a much better job of predicting costs for non-smokers, due to assuming charges follow a skewed gamma distribution, which is much more realistic. Non-smoker predictions are much closer to the y=x line than in the gaussian model.
For smokers the model again overshot many and undershot many, overshooting some by as much as $30,000. This shows that this model doesn't adjust for BMI's specific effect on Smokers over 30.

```{r, echo=FALSE}
model5Plot <- ggplot(data=test_data, aes(Model5Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 5", x = "Prediction", y = "Charges")

model6Plot <- ggplot(data=test_data, aes(Model6Prediction, charges, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=1, color = "steelblue") +
  labs(color = "Smoker", title = "Model 6", x = "Prediction", y = "Charges")

grid.arrange(model5Plot, model6Plot)
paste("RMSE5:",RMSE5)
paste("MAE5:",MAE5)
paste("R^2_5:",r_squared_5)
paste("RMSE6:",RMSE6)
paste("MAE6:",MAE6)
paste("R^2_6:",r_squared_6)
```

The gamma regression models with smoker status' interaction with other terms seems to provide the best estimates of cost for smokers and nonsmokers.
It has less of a gap in the smoker costs than the other models showing it takes into account smoking's compounded effects with BMI and age.

Here are The residual plots to see how each model overshoots/undershoots the real costs

```{r, echo=FALSE}
model1Res <- ggplot(data=test_data, aes(Model1Prediction, charges-Model1Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 1 Residuals")

model2Res <- ggplot(data=test_data, aes(Model2Prediction, charges-Model2Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 2 Residuals")

model3Res <- ggplot(data=test_data, aes(Model3Prediction, charges-Model3Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 3 Residuals")

model4Res <- ggplot(data=test_data, aes(Model4Prediction, charges-Model4Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 4 Residuals")

model5Res <- ggplot(data=test_data, aes(Model5Prediction, charges-Model5Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 5 Residuals")

model6Res <- ggplot(data=test_data, aes(Model6Prediction, charges-Model6Prediction, color = factor(smoker))) +
  geom_point() +
  geom_abline(intercept = 0, slope=0, color = "steelblue") +
  labs(color = "Smoker", y = "Residual", x = "Prediction", title = "Model 6 Residuals")


grid.arrange(model1Res, model2Res, model3Res, model4Res, model5Res, model6Res)

```

# Conclusion

The model with the lowest RMSE, MAE, and highest R^2 (1-RSS/TSS) are the models that use gamma regression and account for interaction between smoker status and the other variables.
This suggests that they are the best models to use to predict the medical costs of new people added into the system.
